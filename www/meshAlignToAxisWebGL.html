<!DOCTYPE html>
<html>
  <head>
    <title>Mesh Align-to-Axis - Toxiclibs.js</title>
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Droid+Serif:400">
    <link rel="stylesheet" href="stylesheets/style.css">
    <script data-main="javascripts/main" src="javascripts/vendor/require.js"></script>
    <script src="javascripts/config.js"></script>
    <!--script(src="javascripts/vendor/xrayquire.js")-->
  </head>
  <body>
    <div id="example-container" class="above canvas">
      <canvas id="example"></canvas>
    </div>
    <script src="https://raw.github.com/hapticdata/toxiclibsjs/master/build/toxiclibs.js"></script>
    <!--https://raw.github.com/hapticdata/toxiclibsjs/develop/build/toxiclibs.min.js")-->
    <script>
//#Mesh Align-to-Axis
//This example uses toxiclibs.js directly with WebGL and no other libraries.
//It shows how to dynamically create a simple box mesh and align it
//with a given direction vector using the `pointTowards()` method of the
//`toxi.geom.mesh.TriangleMesh` class.

//the glsl shaders
var shaders = {
	vertex: [
		"attribute vec3 aVertexPosition;",
		"attribute vec4 aVertexColor;",
		"uniform mat4 uMVMatrix;",
		"uniform mat4 uPMatrix;",
		"varying vec4 vColor;",
		"void main(void) {",
			"gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);",
			"vColor = aVertexColor;",
		"}"
	].join('\n'),
	frag: [
		"#ifdef GL_ES",
		"precision highp float;",
		"#endif",
		"varying vec4 vColor;",
		"void main(void) {",
			"gl_FragColor = vColor;",
		"}"
	].join('\n')
};

window.onload = init;
var canvas, gl;

var TWO_PI = Math.PI * 2;
var BOX_SIZE = new toxi.geom.Vec3D(0.05,0.05,0.5),
	NUM_BOXES = 250,
	//(6 sides * 6 vertices * 3 floats)
	N_PER_BOX = 6 * 6 * 3,
	SCALE= 2,
	lastTime = 0,
	rotBoxes = 0;

var shaderProgram;
//our Model-view matrix
var mvMatrix = new toxi.geom.Matrix4x4(),
	mvMatrixStack = [],
	//our projection matrix
	pMatrix = new toxi.geom.Matrix4x4(),
	//holders for the applied matrice array's
	pM = new Float32Array(16),
	mv = new Float32Array(16);

var boxesVertexPositionBuffer;
var boxesVertexColorBuffer;
var isOver = false;
var rotation = new toxi.geom.Vec3D();


function mouseOver(){
	isOver = true;
}
function mouseOut() {
	isOver = false;
}

function mouseMove(e){
	if(isOver){
		var mouse = {
			x: e.pageX - canvas.offsetLeft,
			y: e.pageY - canvas.offsetTop
		};
		
		rotation.set({
			x: mouse.x * 0.005,
			y: mouse.y * 0.005,
			z: 0
		});
	}
}

function init() {
	canvas = document.getElementById("example");
	canvas.width = window.innerWidth;
	canvas.height = window.innerHeight - 60;
	canvas.addEventListener('mouseover',mouseOver,false);
	canvas.addEventListener('mouseout',mouseOut,false);
	canvas.addEventListener('mousemove',mouseMove,false);
	
	try {
		gl = canvas.getContext("experimental-webgl");
		gl.viewportWidth = canvas.width;
		gl.viewportHeight = canvas.height;
	} catch (e) {
	}
	if (!gl) {
		alert("Could not initialise WebGL, sorry :-(");
	}
	initShaders();
	initBuffers();

	gl.clearColor(0.95, 0.95, 0.95, 1.0);
	gl.enable(gl.DEPTH_TEST);

	tick();
}

function createShader( str, type ){
	var shader = gl.createShader( type );
	gl.shaderSource( shader, str );
	gl.compileShader( shader );
	if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
		alert(gl.getShaderInfoLog(shader));
		return null;
	}
	return shader;
}



function initShaders() {
	var fragmentShader = createShader( shaders.frag, gl.FRAGMENT_SHADER );
	var vertexShader = createShader( shaders.vertex, gl.VERTEX_SHADER );

	shaderProgram = gl.createProgram();
	gl.attachShader(shaderProgram, vertexShader);
	gl.attachShader(shaderProgram, fragmentShader);
	gl.linkProgram(shaderProgram);

	if (!gl.getProgramParameter(shaderProgram, gl.LINK_STATUS)) {
		alert("Could not initialize shaders");
	}

	gl.useProgram(shaderProgram);

	shaderProgram.vertexPositionAttribute = gl.getAttribLocation(shaderProgram, "aVertexPosition");
	gl.enableVertexAttribArray(shaderProgram.vertexPositionAttribute);

	shaderProgram.vertexColorAttribute = gl.getAttribLocation(shaderProgram, "aVertexColor");
	gl.enableVertexAttribArray(shaderProgram.vertexColorAttribute);

	shaderProgram.pMatrixUniform = gl.getUniformLocation(shaderProgram, "uPMatrix");
	shaderProgram.mvMatrixUniform = gl.getUniformLocation(shaderProgram, "uMVMatrix");
}


function mvPushMatrix() {
	mvMatrixStack.push(mvMatrix.copy());
}

function mvPopMatrix() {
	if (mvMatrixStack.length === 0) {
		throw "Invalid popMatrix!";
	}
	mvMatrix = mvMatrixStack.pop();
}


function setMatrixUniforms() {
	//`toxi.geom.Matrix4x4#transpose()` converts the matrix between
	//column-major to row-major (the way that WebGL/OpenGL wants it),
	//by providing `Float32Array`'s we optimize by changing values
	//instead of constructing new objects
	pMatrix.transpose().toArray( pM ),
	mvMatrix.transpose().toArray( mv );
	gl.uniformMatrix4fv(shaderProgram.pMatrixUniform, false, pM);
	gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform, false, mv);
}


function initBuffers() {

	boxesVertexPositionBuffer = gl.createBuffer();
	gl.bindBuffer(gl.ARRAY_BUFFER, boxesVertexPositionBuffer);
	
	//(num of boxes) * (num of sides) * (num of points) * (floats per point [xyz])
	var vertices = new Float32Array(NUM_BOXES * N_PER_BOX);
	var vertIndex = 0;
	var i, dir, pos, b, v;
	for ( i=0; i<NUM_BOXES; i++ ){
		dir = new toxi.geom.Vec3D({
			x: Math.cos(i*TWO_PI/125),
			y: Math.sin(i*TWO_PI/50),
			z: Math.sin(i*TWO_PI/25)
		}).normalize();

		// create a position on a sphere, using the direction vector
		pos = dir.scale(SCALE);
		// create a box mesh at the origin
		b = new toxi.geom.mesh.TriangleMesh("aabb");
		new toxi.geom.AABB(new toxi.geom.Vec3D(), BOX_SIZE).toMesh( b );
		// align the Z axis of the box with the direction vector
		b.pointTowards(dir);
		b.transform(new toxi.geom.Matrix4x4().translateSelf(pos.x,pos.y,pos.z));
		v = new Float32Array(N_PER_BOX);
		b.getMeshAsVertexArray(v,0,3);
		
		vertices.set(v,vertIndex); //push the shape in
		vertIndex += v.length;
		
	}
	
	gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);
	boxesVertexPositionBuffer.itemSize = 3;
	boxesVertexPositionBuffer.numItems = 36 * NUM_BOXES;

	boxesVertexColorBuffer = gl.createBuffer();
	gl.bindBuffer(gl.ARRAY_BUFFER, boxesVertexColorBuffer);
	//(num boxes) * (num sides) * (num points for a color [rgba])
	var colors = new Float32Array(NUM_BOXES * 6 * 6 *4);
	var colorIndex = 0; //this is our colors index

	var nf, p, color1, color2, c1Array, c2Array;
	for ( i=0; i<NUM_BOXES; i++ ) {
		for ( nf=0; nf<6; nf++ ) {
			//6 sides per cube (2 faces per side)
			color1 = toxi.color.TColor.newHSV(i/NUM_BOXES,0.5,0.75);
			color2 = color1.copy().darken(0.125); //second face
			c1Array = color1.toRGBAArray();
			c2Array = color2.toRGBAArray();
			
			for ( p=0; p<3; p++ ) {
				//the first face of the side
				colors.set(c1Array,colorIndex);
				colorIndex += c1Array.length;
			}
			for ( p=0; p<3; p++ ) {
				//the second face of the side
				colors.set(c2Array,colorIndex);
				colorIndex += c2Array.length;
			}
		}
	}
	
	gl.bufferData(gl.ARRAY_BUFFER, colors, gl.STATIC_DRAW);
	boxesVertexColorBuffer.itemSize = 4;
	boxesVertexColorBuffer.numItems = 36 * NUM_BOXES;


}



function drawScene() {
	gl.viewport(0, 0, gl.viewportWidth, gl.viewportHeight);
	gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

	pMatrix.setPerspective(45, gl.viewportWidth / gl.viewportHeight, 0.1, 100.0);

	mvMatrix.identity();
	mvMatrix.translateSelf(0.0, 0.0, -8.0);
	mvPushMatrix();

	var rot = new toxi.geom.Vec3D(0.45,1,0.125)
		.scaleSelf(toxi.math.MathUtils.radians(rotBoxes))
		.addSelf(rotation);
		
	mvMatrix.rotateX(rot.x)
		.rotateY(rot.y)
		.rotateZ(rot.z);

	gl.bindBuffer(gl.ARRAY_BUFFER, boxesVertexPositionBuffer);
	gl.vertexAttribPointer(
		shaderProgram.vertexPositionAttribute,
		boxesVertexPositionBuffer.itemSize,
		gl.FLOAT,
		false,
		0,
		0
	);

	gl.bindBuffer(gl.ARRAY_BUFFER, boxesVertexColorBuffer);
	gl.vertexAttribPointer(
		shaderProgram.vertexColorAttribute,
		boxesVertexColorBuffer.itemSize,
		gl.FLOAT,
		false,
		0,
		0
	);

	setMatrixUniforms();
	gl.drawArrays(gl.TRIANGLES, 0, boxesVertexPositionBuffer.numItems);

	mvPopMatrix();
}




function animate() {
	var timeNow = new Date().getTime();
	if (lastTime !== 0) {
		var elapsed = timeNow - lastTime;

		rotBoxes += (90 * elapsed) / 8000.0;
	}
	lastTime = timeNow;
}


function tick() {
	webkitRequestAnimationFrame(tick);
	drawScene();
	animate();
}</script>
    <section id="waist">
      <nav id="navigation">
        <ul>
          <li class="home"><a href="./">Toxiclibs.js</a></li>
          <li class="examples"><a href="#">Examples</a></li>
          <li class="name">Mesh Align-to-Axis</li>
        </ul>
      </nav>
    </section>
    <section id="pagelet" class="below"><div class="docco annotated-source">     <div class="background"></div>     <ul class="sections">                                <li id="section-1">             <div class="annotation">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                           <h1>Mesh Align-to-Axis</h1>

<p>This example uses toxiclibs.js directly with WebGL and no other libraries.
It shows how to dynamically create a simple box mesh and align it
with a given direction vector using the <code>pointTowards()</code> method of the
<code>toxi.geom.mesh.TriangleMesh</code> class.</p>             </div>                      </li>                              <li id="section-2">             <div class="annotation">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>                           <p>the glsl shaders</p>             </div>                          <div class="content"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">shaders</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">vertex</span><span class="o">:</span> <span class="p">[</span>
    <span class="s2">&quot;attribute vec3 aVertexPosition;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;attribute vec4 aVertexColor;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;uniform mat4 uMVMatrix;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;uniform mat4 uPMatrix;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;varying vec4 vColor;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;void main(void) {&quot;</span><span class="p">,</span>
      <span class="s2">&quot;gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);&quot;</span><span class="p">,</span>
      <span class="s2">&quot;vColor = aVertexColor;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;}&quot;</span>
  <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">),</span>
  <span class="nx">frag</span><span class="o">:</span> <span class="p">[</span>
    <span class="s2">&quot;#ifdef GL_ES&quot;</span><span class="p">,</span>
    <span class="s2">&quot;precision highp float;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;#endif&quot;</span><span class="p">,</span>
    <span class="s2">&quot;varying vec4 vColor;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;void main(void) {&quot;</span><span class="p">,</span>
      <span class="s2">&quot;gl_FragColor = vColor;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;}&quot;</span>
  <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span>
<span class="p">};</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">init</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">canvas</span><span class="p">,</span> <span class="nx">gl</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">TWO_PI</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">BOX_SIZE</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">toxi</span><span class="p">.</span><span class="nx">geom</span><span class="p">.</span><span class="nx">Vec3D</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.5</span><span class="p">),</span>
  <span class="nx">NUM_BOXES</span> <span class="o">=</span> <span class="mi">250</span><span class="p">,</span></pre></div></div>                      </li>                              <li id="section-3">             <div class="annotation">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>                           <p>(6 sides * 6 vertices * 3 floats)</p>             </div>                          <div class="content"><div class="highlight"><pre>  <span class="nx">N_PER_BOX</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>
  <span class="nx">SCALE</span><span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nx">lastTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nx">rotBoxes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">shaderProgram</span><span class="p">;</span></pre></div></div>                      </li>                              <li id="section-4">             <div class="annotation">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>                           <p>our Model-view matrix</p>             </div>                          <div class="content"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">mvMatrix</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">toxi</span><span class="p">.</span><span class="nx">geom</span><span class="p">.</span><span class="nx">Matrix4x4</span><span class="p">(),</span>
  <span class="nx">mvMatrixStack</span> <span class="o">=</span> <span class="p">[],</span></pre></div></div>                      </li>                              <li id="section-5">             <div class="annotation">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>                           <p>our projection matrix</p>             </div>                          <div class="content"><div class="highlight"><pre>  <span class="nx">pMatrix</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">toxi</span><span class="p">.</span><span class="nx">geom</span><span class="p">.</span><span class="nx">Matrix4x4</span><span class="p">(),</span></pre></div></div>                      </li>                              <li id="section-6">             <div class="annotation">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>                           <p>holders for the applied matrice array's</p>             </div>                          <div class="content"><div class="highlight"><pre>  <span class="nx">pM</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span>
  <span class="nx">mv</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">boxesVertexPositionBuffer</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">boxesVertexColorBuffer</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">isOver</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">rotation</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">toxi</span><span class="p">.</span><span class="nx">geom</span><span class="p">.</span><span class="nx">Vec3D</span><span class="p">();</span>


<span class="kd">function</span> <span class="nx">mouseOver</span><span class="p">(){</span>
  <span class="nx">isOver</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">mouseOut</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">isOver</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">mouseMove</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">isOver</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">mouse</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">x</span><span class="o">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageX</span> <span class="o">-</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">offsetLeft</span><span class="p">,</span>
      <span class="nx">y</span><span class="o">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageY</span> <span class="o">-</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">offsetTop</span>
    <span class="p">};</span>
    
    <span class="nx">rotation</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
      <span class="nx">x</span><span class="o">:</span> <span class="nx">mouse</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="mf">0.005</span><span class="p">,</span>
      <span class="nx">y</span><span class="o">:</span> <span class="nx">mouse</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="mf">0.005</span><span class="p">,</span>
      <span class="nx">z</span><span class="o">:</span> <span class="mi">0</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">init</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">canvas</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;example&quot;</span><span class="p">);</span>
  <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerWidth</span><span class="p">;</span>
  <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerHeight</span> <span class="o">-</span> <span class="mi">60</span><span class="p">;</span>
  <span class="nx">canvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;mouseover&#39;</span><span class="p">,</span><span class="nx">mouseOver</span><span class="p">,</span><span class="kc">false</span><span class="p">);</span>
  <span class="nx">canvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;mouseout&#39;</span><span class="p">,</span><span class="nx">mouseOut</span><span class="p">,</span><span class="kc">false</span><span class="p">);</span>
  <span class="nx">canvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;mousemove&#39;</span><span class="p">,</span><span class="nx">mouseMove</span><span class="p">,</span><span class="kc">false</span><span class="p">);</span>
  
  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">gl</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">&quot;experimental-webgl&quot;</span><span class="p">);</span>
    <span class="nx">gl</span><span class="p">.</span><span class="nx">viewportWidth</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
    <span class="nx">gl</span><span class="p">.</span><span class="nx">viewportHeight</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">gl</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Could not initialise WebGL, sorry :-(&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">initShaders</span><span class="p">();</span>
  <span class="nx">initBuffers</span><span class="p">();</span>

  <span class="nx">gl</span><span class="p">.</span><span class="nx">clearColor</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
  <span class="nx">gl</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">DEPTH_TEST</span><span class="p">);</span>

  <span class="nx">tick</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">createShader</span><span class="p">(</span> <span class="nx">str</span><span class="p">,</span> <span class="nx">type</span> <span class="p">){</span>
  <span class="kd">var</span> <span class="nx">shader</span> <span class="o">=</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">createShader</span><span class="p">(</span> <span class="nx">type</span> <span class="p">);</span>
  <span class="nx">gl</span><span class="p">.</span><span class="nx">shaderSource</span><span class="p">(</span> <span class="nx">shader</span><span class="p">,</span> <span class="nx">str</span> <span class="p">);</span>
  <span class="nx">gl</span><span class="p">.</span><span class="nx">compileShader</span><span class="p">(</span> <span class="nx">shader</span> <span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">gl</span><span class="p">.</span><span class="nx">getShaderParameter</span><span class="p">(</span><span class="nx">shader</span><span class="p">,</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">COMPILE_STATUS</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">getShaderInfoLog</span><span class="p">(</span><span class="nx">shader</span><span class="p">));</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">shader</span><span class="p">;</span>
<span class="p">}</span>



<span class="kd">function</span> <span class="nx">initShaders</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">fragmentShader</span> <span class="o">=</span> <span class="nx">createShader</span><span class="p">(</span> <span class="nx">shaders</span><span class="p">.</span><span class="nx">frag</span><span class="p">,</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">FRAGMENT_SHADER</span> <span class="p">);</span>
  <span class="kd">var</span> <span class="nx">vertexShader</span> <span class="o">=</span> <span class="nx">createShader</span><span class="p">(</span> <span class="nx">shaders</span><span class="p">.</span><span class="nx">vertex</span><span class="p">,</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">VERTEX_SHADER</span> <span class="p">);</span>

  <span class="nx">shaderProgram</span> <span class="o">=</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">createProgram</span><span class="p">();</span>
  <span class="nx">gl</span><span class="p">.</span><span class="nx">attachShader</span><span class="p">(</span><span class="nx">shaderProgram</span><span class="p">,</span> <span class="nx">vertexShader</span><span class="p">);</span>
  <span class="nx">gl</span><span class="p">.</span><span class="nx">attachShader</span><span class="p">(</span><span class="nx">shaderProgram</span><span class="p">,</span> <span class="nx">fragmentShader</span><span class="p">);</span>
  <span class="nx">gl</span><span class="p">.</span><span class="nx">linkProgram</span><span class="p">(</span><span class="nx">shaderProgram</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">gl</span><span class="p">.</span><span class="nx">getProgramParameter</span><span class="p">(</span><span class="nx">shaderProgram</span><span class="p">,</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">LINK_STATUS</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Could not initialize shaders&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">gl</span><span class="p">.</span><span class="nx">useProgram</span><span class="p">(</span><span class="nx">shaderProgram</span><span class="p">);</span>

  <span class="nx">shaderProgram</span><span class="p">.</span><span class="nx">vertexPositionAttribute</span> <span class="o">=</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">getAttribLocation</span><span class="p">(</span><span class="nx">shaderProgram</span><span class="p">,</span> <span class="s2">&quot;aVertexPosition&quot;</span><span class="p">);</span>
  <span class="nx">gl</span><span class="p">.</span><span class="nx">enableVertexAttribArray</span><span class="p">(</span><span class="nx">shaderProgram</span><span class="p">.</span><span class="nx">vertexPositionAttribute</span><span class="p">);</span>

  <span class="nx">shaderProgram</span><span class="p">.</span><span class="nx">vertexColorAttribute</span> <span class="o">=</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">getAttribLocation</span><span class="p">(</span><span class="nx">shaderProgram</span><span class="p">,</span> <span class="s2">&quot;aVertexColor&quot;</span><span class="p">);</span>
  <span class="nx">gl</span><span class="p">.</span><span class="nx">enableVertexAttribArray</span><span class="p">(</span><span class="nx">shaderProgram</span><span class="p">.</span><span class="nx">vertexColorAttribute</span><span class="p">);</span>

  <span class="nx">shaderProgram</span><span class="p">.</span><span class="nx">pMatrixUniform</span> <span class="o">=</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span><span class="nx">shaderProgram</span><span class="p">,</span> <span class="s2">&quot;uPMatrix&quot;</span><span class="p">);</span>
  <span class="nx">shaderProgram</span><span class="p">.</span><span class="nx">mvMatrixUniform</span> <span class="o">=</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">getUniformLocation</span><span class="p">(</span><span class="nx">shaderProgram</span><span class="p">,</span> <span class="s2">&quot;uMVMatrix&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="kd">function</span> <span class="nx">mvPushMatrix</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">mvMatrixStack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">mvMatrix</span><span class="p">.</span><span class="nx">copy</span><span class="p">());</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">mvPopMatrix</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">mvMatrixStack</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="s2">&quot;Invalid popMatrix!&quot;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">mvMatrix</span> <span class="o">=</span> <span class="nx">mvMatrixStack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
<span class="p">}</span>


<span class="kd">function</span> <span class="nx">setMatrixUniforms</span><span class="p">()</span> <span class="p">{</span></pre></div></div>                      </li>                              <li id="section-7">             <div class="annotation">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>                           <p><code>toxi.geom.Matrix4x4#transpose()</code> converts the matrix between
column-major to row-major (the way that WebGL/OpenGL wants it),
by providing <code>Float32Array</code>'s we optimize by changing values
instead of constructing new objects</p>             </div>                          <div class="content"><div class="highlight"><pre>  <span class="nx">pMatrix</span><span class="p">.</span><span class="nx">transpose</span><span class="p">().</span><span class="nx">toArray</span><span class="p">(</span> <span class="nx">pM</span> <span class="p">),</span>
  <span class="nx">mvMatrix</span><span class="p">.</span><span class="nx">transpose</span><span class="p">().</span><span class="nx">toArray</span><span class="p">(</span> <span class="nx">mv</span> <span class="p">);</span>
  <span class="nx">gl</span><span class="p">.</span><span class="nx">uniformMatrix4fv</span><span class="p">(</span><span class="nx">shaderProgram</span><span class="p">.</span><span class="nx">pMatrixUniform</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">pM</span><span class="p">);</span>
  <span class="nx">gl</span><span class="p">.</span><span class="nx">uniformMatrix4fv</span><span class="p">(</span><span class="nx">shaderProgram</span><span class="p">.</span><span class="nx">mvMatrixUniform</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">mv</span><span class="p">);</span>
<span class="p">}</span>


<span class="kd">function</span> <span class="nx">initBuffers</span><span class="p">()</span> <span class="p">{</span>

  <span class="nx">boxesVertexPositionBuffer</span> <span class="o">=</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>
  <span class="nx">gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">boxesVertexPositionBuffer</span><span class="p">);</span>
  </pre></div></div>                      </li>                              <li id="section-8">             <div class="annotation">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>                           <p>(num of boxes) * (num of sides) * (num of points) * (floats per point [xyz])</p>             </div>                          <div class="content"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">vertices</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="nx">NUM_BOXES</span> <span class="o">*</span> <span class="nx">N_PER_BOX</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">vertIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">dir</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">v</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">NUM_BOXES</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">){</span>
    <span class="nx">dir</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">toxi</span><span class="p">.</span><span class="nx">geom</span><span class="p">.</span><span class="nx">Vec3D</span><span class="p">({</span>
      <span class="nx">x</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">i</span><span class="o">*</span><span class="nx">TWO_PI</span><span class="o">/</span><span class="mi">125</span><span class="p">),</span>
      <span class="nx">y</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">i</span><span class="o">*</span><span class="nx">TWO_PI</span><span class="o">/</span><span class="mi">50</span><span class="p">),</span>
      <span class="nx">z</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">i</span><span class="o">*</span><span class="nx">TWO_PI</span><span class="o">/</span><span class="mi">25</span><span class="p">)</span>
    <span class="p">}).</span><span class="nx">normalize</span><span class="p">();</span></pre></div></div>                      </li>                              <li id="section-9">             <div class="annotation">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>                           <p>create a position on a sphere, using the direction vector</p>             </div>                          <div class="content"><div class="highlight"><pre>    <span class="nx">pos</span> <span class="o">=</span> <span class="nx">dir</span><span class="p">.</span><span class="nx">scale</span><span class="p">(</span><span class="nx">SCALE</span><span class="p">);</span></pre></div></div>                      </li>                              <li id="section-10">             <div class="annotation">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>                           <p>create a box mesh at the origin</p>             </div>                          <div class="content"><div class="highlight"><pre>    <span class="nx">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">toxi</span><span class="p">.</span><span class="nx">geom</span><span class="p">.</span><span class="nx">mesh</span><span class="p">.</span><span class="nx">TriangleMesh</span><span class="p">(</span><span class="s2">&quot;aabb&quot;</span><span class="p">);</span>
    <span class="k">new</span> <span class="nx">toxi</span><span class="p">.</span><span class="nx">geom</span><span class="p">.</span><span class="nx">AABB</span><span class="p">(</span><span class="k">new</span> <span class="nx">toxi</span><span class="p">.</span><span class="nx">geom</span><span class="p">.</span><span class="nx">Vec3D</span><span class="p">(),</span> <span class="nx">BOX_SIZE</span><span class="p">).</span><span class="nx">toMesh</span><span class="p">(</span> <span class="nx">b</span> <span class="p">);</span></pre></div></div>                      </li>                              <li id="section-11">             <div class="annotation">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>                           <p>align the Z axis of the box with the direction vector</p>             </div>                          <div class="content"><div class="highlight"><pre>    <span class="nx">b</span><span class="p">.</span><span class="nx">pointTowards</span><span class="p">(</span><span class="nx">dir</span><span class="p">);</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span><span class="k">new</span> <span class="nx">toxi</span><span class="p">.</span><span class="nx">geom</span><span class="p">.</span><span class="nx">Matrix4x4</span><span class="p">().</span><span class="nx">translateSelf</span><span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span><span class="nx">pos</span><span class="p">.</span><span class="nx">z</span><span class="p">));</span>
    <span class="nx">v</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="nx">N_PER_BOX</span><span class="p">);</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">getMeshAsVertexArray</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
    
    <span class="nx">vertices</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span><span class="nx">vertIndex</span><span class="p">);</span> <span class="c1">//push the shape in</span>
    <span class="nx">vertIndex</span> <span class="o">+=</span> <span class="nx">v</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    
  <span class="p">}</span>
  
  <span class="nx">gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">vertices</span><span class="p">,</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">STATIC_DRAW</span><span class="p">);</span>
  <span class="nx">boxesVertexPositionBuffer</span><span class="p">.</span><span class="nx">itemSize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="nx">boxesVertexPositionBuffer</span><span class="p">.</span><span class="nx">numItems</span> <span class="o">=</span> <span class="mi">36</span> <span class="o">*</span> <span class="nx">NUM_BOXES</span><span class="p">;</span>

  <span class="nx">boxesVertexColorBuffer</span> <span class="o">=</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">createBuffer</span><span class="p">();</span>
  <span class="nx">gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">boxesVertexColorBuffer</span><span class="p">);</span></pre></div></div>                      </li>                              <li id="section-12">             <div class="annotation">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>                           <p>(num boxes) * (num sides) * (num points for a color [rgba])</p>             </div>                          <div class="content"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">colors</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="nx">NUM_BOXES</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">*</span><span class="mi">4</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">colorIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//this is our colors index</span>

  <span class="kd">var</span> <span class="nx">nf</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">color1</span><span class="p">,</span> <span class="nx">color2</span><span class="p">,</span> <span class="nx">c1Array</span><span class="p">,</span> <span class="nx">c2Array</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">NUM_BOXES</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span> <span class="nx">nf</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">nf</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">;</span> <span class="nx">nf</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span></pre></div></div>                      </li>                              <li id="section-13">             <div class="annotation">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>                           <p>6 sides per cube (2 faces per side)</p>             </div>                          <div class="content"><div class="highlight"><pre>      <span class="nx">color1</span> <span class="o">=</span> <span class="nx">toxi</span><span class="p">.</span><span class="nx">color</span><span class="p">.</span><span class="nx">TColor</span><span class="p">.</span><span class="nx">newHSV</span><span class="p">(</span><span class="nx">i</span><span class="o">/</span><span class="nx">NUM_BOXES</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.75</span><span class="p">);</span>
      <span class="nx">color2</span> <span class="o">=</span> <span class="nx">color1</span><span class="p">.</span><span class="nx">copy</span><span class="p">().</span><span class="nx">darken</span><span class="p">(</span><span class="mf">0.125</span><span class="p">);</span> <span class="c1">//second face</span>
      <span class="nx">c1Array</span> <span class="o">=</span> <span class="nx">color1</span><span class="p">.</span><span class="nx">toRGBAArray</span><span class="p">();</span>
      <span class="nx">c2Array</span> <span class="o">=</span> <span class="nx">color2</span><span class="p">.</span><span class="nx">toRGBAArray</span><span class="p">();</span>
      
      <span class="k">for</span> <span class="p">(</span> <span class="nx">p</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">p</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="nx">p</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span></pre></div></div>                      </li>                              <li id="section-14">             <div class="annotation">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>                           <p>the first face of the side</p>             </div>                          <div class="content"><div class="highlight"><pre>        <span class="nx">colors</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">c1Array</span><span class="p">,</span><span class="nx">colorIndex</span><span class="p">);</span>
        <span class="nx">colorIndex</span> <span class="o">+=</span> <span class="nx">c1Array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span> <span class="nx">p</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">p</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="nx">p</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span></pre></div></div>                      </li>                              <li id="section-15">             <div class="annotation">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>                           <p>the second face of the side</p>             </div>                          <div class="content"><div class="highlight"><pre>        <span class="nx">colors</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">c2Array</span><span class="p">,</span><span class="nx">colorIndex</span><span class="p">);</span>
        <span class="nx">colorIndex</span> <span class="o">+=</span> <span class="nx">c2Array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">gl</span><span class="p">.</span><span class="nx">bufferData</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">colors</span><span class="p">,</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">STATIC_DRAW</span><span class="p">);</span>
  <span class="nx">boxesVertexColorBuffer</span><span class="p">.</span><span class="nx">itemSize</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="nx">boxesVertexColorBuffer</span><span class="p">.</span><span class="nx">numItems</span> <span class="o">=</span> <span class="mi">36</span> <span class="o">*</span> <span class="nx">NUM_BOXES</span><span class="p">;</span>


<span class="p">}</span>



<span class="kd">function</span> <span class="nx">drawScene</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">gl</span><span class="p">.</span><span class="nx">viewport</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">viewportWidth</span><span class="p">,</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">viewportHeight</span><span class="p">);</span>
  <span class="nx">gl</span><span class="p">.</span><span class="nx">clear</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">COLOR_BUFFER_BIT</span> <span class="o">|</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">DEPTH_BUFFER_BIT</span><span class="p">);</span>

  <span class="nx">pMatrix</span><span class="p">.</span><span class="nx">setPerspective</span><span class="p">(</span><span class="mi">45</span><span class="p">,</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">viewportWidth</span> <span class="o">/</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">viewportHeight</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">);</span>

  <span class="nx">mvMatrix</span><span class="p">.</span><span class="nx">identity</span><span class="p">();</span>
  <span class="nx">mvMatrix</span><span class="p">.</span><span class="nx">translateSelf</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.0</span><span class="p">);</span>
  <span class="nx">mvPushMatrix</span><span class="p">();</span>

  <span class="kd">var</span> <span class="nx">rot</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">toxi</span><span class="p">.</span><span class="nx">geom</span><span class="p">.</span><span class="nx">Vec3D</span><span class="p">(</span><span class="mf">0.45</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.125</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">scaleSelf</span><span class="p">(</span><span class="nx">toxi</span><span class="p">.</span><span class="nx">math</span><span class="p">.</span><span class="nx">MathUtils</span><span class="p">.</span><span class="nx">radians</span><span class="p">(</span><span class="nx">rotBoxes</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">addSelf</span><span class="p">(</span><span class="nx">rotation</span><span class="p">);</span>
    
  <span class="nx">mvMatrix</span><span class="p">.</span><span class="nx">rotateX</span><span class="p">(</span><span class="nx">rot</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">rotateY</span><span class="p">(</span><span class="nx">rot</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">rotateZ</span><span class="p">(</span><span class="nx">rot</span><span class="p">.</span><span class="nx">z</span><span class="p">);</span>

  <span class="nx">gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">boxesVertexPositionBuffer</span><span class="p">);</span>
  <span class="nx">gl</span><span class="p">.</span><span class="nx">vertexAttribPointer</span><span class="p">(</span>
    <span class="nx">shaderProgram</span><span class="p">.</span><span class="nx">vertexPositionAttribute</span><span class="p">,</span>
    <span class="nx">boxesVertexPositionBuffer</span><span class="p">.</span><span class="nx">itemSize</span><span class="p">,</span>
    <span class="nx">gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span>
    <span class="kc">false</span><span class="p">,</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="mi">0</span>
  <span class="p">);</span>

  <span class="nx">gl</span><span class="p">.</span><span class="nx">bindBuffer</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">ARRAY_BUFFER</span><span class="p">,</span> <span class="nx">boxesVertexColorBuffer</span><span class="p">);</span>
  <span class="nx">gl</span><span class="p">.</span><span class="nx">vertexAttribPointer</span><span class="p">(</span>
    <span class="nx">shaderProgram</span><span class="p">.</span><span class="nx">vertexColorAttribute</span><span class="p">,</span>
    <span class="nx">boxesVertexColorBuffer</span><span class="p">.</span><span class="nx">itemSize</span><span class="p">,</span>
    <span class="nx">gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span>
    <span class="kc">false</span><span class="p">,</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="mi">0</span>
  <span class="p">);</span>

  <span class="nx">setMatrixUniforms</span><span class="p">();</span>
  <span class="nx">gl</span><span class="p">.</span><span class="nx">drawArrays</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">TRIANGLES</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">boxesVertexPositionBuffer</span><span class="p">.</span><span class="nx">numItems</span><span class="p">);</span>

  <span class="nx">mvPopMatrix</span><span class="p">();</span>
<span class="p">}</span>




<span class="kd">function</span> <span class="nx">animate</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">timeNow</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">lastTime</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">elapsed</span> <span class="o">=</span> <span class="nx">timeNow</span> <span class="o">-</span> <span class="nx">lastTime</span><span class="p">;</span>

    <span class="nx">rotBoxes</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">90</span> <span class="o">*</span> <span class="nx">elapsed</span><span class="p">)</span> <span class="o">/</span> <span class="mf">8000.0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">lastTime</span> <span class="o">=</span> <span class="nx">timeNow</span><span class="p">;</span>
<span class="p">}</span>


<span class="kd">function</span> <span class="nx">tick</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">webkitRequestAnimationFrame</span><span class="p">(</span><span class="nx">tick</span><span class="p">);</span>
  <span class="nx">drawScene</span><span class="p">();</span>
  <span class="nx">animate</span><span class="p">();</span>
<span class="p">}</span>

</pre></div></div>                      </li>              </ul>  </div> </section>
    <footer class="container-fluid">
      <div class="row-fluid">
        <div class="span6 about"><ul>
<li><strong><em><a href="http://hapticdata.com/toxiclibjs">Toxiclibs.js</a></em> is created and maintained by <a href="http://hapticdata.com">Kyle Phillips</a></strong></li>
<li><strong>The original <em><a href="http://toxiclibs.org">Toxiclibs</a></em> is created and maintained by <a href="http://postspectacular.com">Karsten Schmidt</a></strong></li>
<li><em>Toxiclibs.js</em>, <em>Toxiclibs</em> and the <em>toxiclibs.js website</em> are all free open-source software released under 
<a href="https://github.com/hapticdata/toxiclibsjs/blob/develop/LICENSE.txt">GNU Lesser General Public License</a></li>
</ul>
        </div>
        <div class="span6">
          <ul class="quick-links">
            <li><a href="https://github.com/hapticdata/toxiclibsjs">View on Github</a></li>
            <li><a href="https://github.com/hapticdata/toxiclibsjs/graphs/contributors">Contributors</a></li>
            <li>Download:
              <ul class="quick-links">
                <li><a href="https://github.com/hapticdata/toxiclibsjs/archive/master.zip">Repository</a></li>
                <li><a href="https://raw.github.com/hapticdata/toxiclibsjs/master/build/toxiclibs.js">build</a></li>
                <li><a href="https://raw.github.com/hapticdata/toxiclibsjs/master/build/toxiclibs.min.js">minified build</a></li>
              </ul></li>
          </ul><p><em>This site and examples are 
<a href="https://github.com/hapticdata/toxiclibsjs-examples">separately available on Github</a>
and were created by <a href="http://hapticdata.com">Kyle Phillips</a> unless otherwise noted.</em></p>
        </div>
      </div>
    </footer>
  </body>
</html>